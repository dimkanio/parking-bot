# admin-duty-bot

### Описание
Бот для ведения дежурств и нотификаций о каких-то событиях. Читает календари Zimbra, шлет нотификацию в чат, считает статистику.
Каждый день в 10:00 утра бот читает календарь, шлет в чат сообщение о дежурном на сегодня и запинивает. Если бот не смог определеить дежурного, шлет алерт в чат управления ботом, что дежурный не назначен. 
Также каждый день в 19:30 вечера бот проверяет, что на завтра дежурный назначен. Если нет, то алерт в чат управлени ботом.

Примечание: дежурных нужно назначать с пометкой all day, а не на конкретное время! В названии события обязательно указыавть telegram ник с символом @ и признак выходного дня с символом # (#0 - обычный день (по дефолту), #1 - выходной или праздник), а также в круглых скобках указать роль. 
Напаример, 
`Ivanon Ivan @ivanovV #0 (Admin)` - дежурный админ @ivanovV в обычный день
`Petrov P @pppttr #1 (Itsec)` - дежурный безопасник @pppttr в выходной день

Помимо этого, бот использует еще один календарь - Календарь событий. В этом календаре можно указывать какие-то технические работы по плану, внешние события и все подобное, что может быть полезно знать дежурным в чате*.

*Пока данный функционал в разработке.

### Команды для пользователей
`/start - Запустить/Перезапустить бота `

`/help - Инструкция `

`/dutystatmonth - Собрать статистику по дежурствам (без параметров посчитает текущий месяц, но можно передать параметр к команде чере пробел в формате YYYYMM, например, /dutystatmonth 202201 - посчитает за январь)`

`/forceupdatetoday - Принудительно обновить нотификацию о дежурствах в чате (на случай изменений в календаре)`

`/checktomorrow - Проверить, есть ли в календаре дежурные на завтра`

### Настройка и инсталяция
Упаковано в docker-compose связку образов: postgresql база + python приложение.

1. Нужно создать файл в корне .env и прописать там параметры:

`POSTGRES_PASSWORD_1, POSTGRES_PASSWORD_2 - пароль базы (одинаковый)`

`TOKEN - telegram токен бота `

`DUTY_ADM_ICS_URL - URL для календаря дежурств (https://mail.itechpsp.com/home/admins-calendar@itechpsp.com/duty)`

`DUTY_ADM_CHAT_ID - ID чата для нотификации о дежурствах (админские права)`

`EVENT_ICS_URL - URL для календаря событий`

`ADM_CONTROL_DUTY_CHAT_ID - ID чата, в котором только дежурные админы (нужно назначить админом чата пользователя если нужно, чтобы он мог запрашивать статистику или через бота принудительно обновлять запиненные сообщения)`

`DUTY_ALERT_TIME - время, когда происходит смена дежурных в UTC (например, 07:00)`

`CHECK_TOMORROW_ALERT_TIME - время, когда происходит проверка того, что в календаре уже назначены дежурные на завтра (например, 16:30)`

`LOGLEVEL - уровень логирования (DEBUG, INFO, WARNING, ERROR)`

`TARIFF_WORKDAY - тариф оплаты дежурного в обычный день`

`TARIFF_WEEKEND - тариф оплаты дежурного в праздничный/выходной день`

`AUTH_TYPE - тип аутентификации в Zimbra (LOGOPASS, TOKEN). В зависимости от этого параметра будут использованы соответствующие данные из конфига.`

`ZM_AUTH_TOKEN - токен для авторизации в zimbra (генерируется запросом вида "curl --user 'admins-calendar@itechpsp.com:PASSWORD' -k 'https://mail.itechpsp.com/home/admins-calendar@itechpsp.com/Inbox/?fmt=sync&auth=sc' -c 'token.txt' ")`

`LOGIN - логин (если используется аутентификация по токену, можно любое значение вписать)`

`PASSWORD - пароль (если используется аутентификация по токену, можно любое значение вписать)`

2. В корне проекта запустить 

`docker-compose up --build -d`

Проверить, что работает:

`docker ps`

3. Если надо потушить

`docker-compose down `
